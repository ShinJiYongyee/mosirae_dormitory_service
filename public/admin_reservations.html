<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>admin reservations</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="min-h-screen bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <div class="flex items-center justify-between">
            <a id="lnk-home" href="/" class="text-blue-600 hover:text-blue-500"></a>
            <div class="space-x-3">
                <span id="txt-title-mini" class="text-sm font-semibold text-gray-900"></span>
                <span class="text-sm text-gray-400">|</span>
                <a id="lnk-wl" href="/admin/waitlist" class="text-sm text-gray-700 hover:underline"></a>
            </div>
        </div>

        <div class="max-w-6xl mx-auto bg-white rounded-lg shadow mt-6">
            <div class="p-6 border-b">
                <h1 id="txt-title" class="text-2xl font-bold"></h1>
                <p id="txt-sub" class="text-gray-500 text-sm mt-1"></p>
            </div>

            <div class="p-6 space-y-4">
                <div class="grid grid-cols-3 gap-3">
                    <input id="adm-room" class="border rounded p-2" placeholder="" />
                    <input id="adm-date" type="date" class="border rounded p-2" />
                    <button id="adm-load" class="bg-gray-800 text-white py-2 rounded"></button>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-3 py-2 text-left">roomId</th>
                                <th class="px-3 py-2 text-left">date</th>
                                <th class="px-3 py-2 text-left">timeSlot</th>
                                <th class="px-3 py-2 text-left">status</th>
                                <th class="px-3 py-2 text-left">studentId</th>
                                <th class="px-3 py-2 text-left">name</th>
                                <th class="px-3 py-2 text-left">_id</th>
                                <th id="th-action" class="px-3 py-2 text-left"></th>
                            </tr>
                        </thead>
                        <tbody id="adm-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function () {
            const K = (s) => decodeURIComponent(s);

            // ===== �ѱ� �ؽ�Ʈ ���� (�ۼ�Ʈ ���ڵ� ���) =====
            document.title = K("%EC%98%88%EC%95%BD%20%EB%AA%A9%EB%A1%9D%28%EA%B4%80%EB%A6%AC%EC%9E%90%29"); // ���� ���(������)
            document.getElementById("lnk-home").textContent = K("%E2%86%90%20%EB%A9%94%EC%9D%B8"); // �� ����
            document.getElementById("txt-title-mini").textContent = K("%EC%98%88%EC%95%BD%20%EB%AA%A9%EB%A1%9D%28%EC%A0%84%EC%B2%B4%29"); // ���� ���(��ü)
            document.getElementById("lnk-wl").textContent = K("%EB%8C%80%EA%B8%B0%EC%97%B4%20%EA%B4%80%EB%A6%AC"); // ��⿭ ����
            document.getElementById("txt-title").textContent = K("%EC%98%88%EC%95%BD%20%EB%AA%A9%EB%A1%9D%28%EC%A0%84%EC%B2%B4%29");
            document.getElementById("txt-sub").textContent = K("%ED%95%84%ED%84%B0%20%EC%97%86%EC%9D%B4%20%E2%80%9C%EB%B6%88%EB%9F%AC%EC%98%A4%EA%B8%B0%E2%80%9D%EB%A5%BC%20%EB%88%84%EB%A5%B4%EB%A9%B4%20%EC%A0%84%EC%B2%B4%20%EC%98%88%EC%95%BD%20%EB%82%B4%EC%97%AD%EC%9D%B4%20%ED%91%9C%EC%8B%9C%EB%90%A9%EB%8B%88%EB%8B%A4.");
            // ���� ���� ���ҷ����⡱�� ������ ��ü ���� ������ ǥ�õ˴ϴ�.
            document.getElementById("adm-room").placeholder = K("%EA%B3%B5%EA%B0%84%28%EC%98%88%3A%20R101%2C%20%EB%B9%84%EC%9A%B0%EB%A9%B4%20%EC%A0%84%EC%B2%B4%29");
            document.getElementById("adm-load").textContent = K("%EB%B6%88%EB%9F%AC%EC%98%A4%EA%B8%B0"); // �ҷ�����
            document.getElementById("th-action").textContent = K("%EC%A1%B0%EC%9E%91"); // ����

            const room = document.getElementById("adm-room");
            const date = document.getElementById("adm-date");
            const load = document.getElementById("adm-load");
            const tbody = document.getElementById("adm-tbody");

            // ���� ��¥ placeholder
            if (!date.value) {
                const t = new Date(); const y = t.getFullYear(); const m = String(t.getMonth() + 1).padStart(2, "0"); const d = String(t.getDate()).padStart(2, "0");
                date.placeholder = `${y}-${m}-${d}`;
            }

            load.addEventListener("click", async () => {
                const q = new URLSearchParams();
                if (room.value) q.set("roomId", room.value);
                if (date.value) q.set("date", date.value);

                // ������ ���� API (Basic Auth�� ��ȣ��)
                const res = await fetch(`/api/reservations?${q}`);
                const json = await res.json();

                tbody.innerHTML = "";
                (json.data || []).forEach(item => {
                    const tr = document.createElement("tr");
                    tr.className = "border-b";
                    tr.innerHTML = `
                <td class="px-3 py-2">${item.roomId || ""}</td>
                <td class="px-3 py-2">${item.date || ""}</td>
                <td class="px-3 py-2">${item.timeSlot || ""}</td>
                <td class="px-3 py-2">${item.status || ""}</td>
                <td class="px-3 py-2">${item.requester?.studentId || ""}</td>
                <td class="px-3 py-2">${item.requester?.name || ""}</td>
                <td class="px-3 py-2">${item._id}</td>
                <td class="px-3 py-2">
                  ${item.status !== "canceled" ? `<button data-id="${item._id}" class="px-2 py-1 border rounded hover:bg-gray-50">${K("%EC%B7%A8%EC%86%8C")}</button>` : ""}
                </td>
              `;
                    tbody.appendChild(tr);
                });

                // ��� ��ư
                [...tbody.querySelectorAll("button[data-id]")].forEach(btn => {
                    btn.addEventListener("click", async () => {
                        const id = btn.getAttribute("data-id");
                        if (!confirm(K("%EC%A0%95%EB%A7%90%20%EC%B7%A8%EC%86%8C%ED%95%98%EC%8B%9C%EA%B2%A0%EC%8A%B5%EB%8B%88%EA%B9%8C%3F"))) return;
                        const res = await fetch(`/api/reservations/${id}/cancel`, { method: "PATCH" });
                        const json = await res.json();
                        if (!json.ok) { alert(K("%EC%B7%A8%EC%86%8C%20%EC%8B%A4%ED%8C%A8")); return; }
                        alert(K("%EC%B7%A8%EC%86%8C%20%EC%99%84%EB%A3%8C"));// + (json.data.promoted ? " (��⿭ �°ݵ�)" : "")
                        load.click();
                    });
                });
            });

            // �ڵ� ��ȸ
            load.click();
        })();
    </script>
</body>
</html>
